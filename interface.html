
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Interface Design &#8212; XAJ 0.2.0-dev documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Design Patterns" href="pattern.html" />
    <link rel="prev" title="XAJ: Numerical Integrators for JAX" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="interface-design">
<h1>Interface Design<a class="headerlink" href="#interface-design" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">JAX</span></code> is an extensible system for transforming numerical functions.
The basic transformations are: <code class="docutils literal notranslate"><span class="pre">grad</span></code>, <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, and
<code class="docutils literal notranslate"><span class="pre">pmap</span></code>.
To make <code class="docutils literal notranslate"><span class="pre">XAJ</span></code> interpolate well with <code class="docutils literal notranslate"><span class="pre">JAX</span></code>, we design <code class="docutils literal notranslate"><span class="pre">odeint</span></code> to
behave the same way as <code class="docutils literal notranslate"><span class="pre">grad</span></code> and be composable with other <code class="docutils literal notranslate"><span class="pre">JAX</span></code>
transformations.
This is challenging because we are mixing autodiff, which works well
with pure functions, with numerical integration, which requires some
internal states.</p>
<section id="solution-callable">
<h2>Solution Callable<a class="headerlink" href="#solution-callable" title="Permalink to this headline">¶</a></h2>
<p>Consider the ordinary differential equations (ODEs)</p>
<div class="math notranslate nohighlight">
\[\frac{d\mathbf{x}}{dt} = f(t, \mathbf{x})\]</div>
<p>and use a python <strong>callable</strong> <code class="docutils literal notranslate"><span class="pre">x(t)</span></code> to represent its (numerical)
solution.
We want to design <code class="docutils literal notranslate"><span class="pre">XAJ</span></code> in a way that it works naturally with
<code class="docutils literal notranslate"><span class="pre">JAX</span></code>’s automatic differentiation interface.</p>
<ol class="arabic simple">
<li><p>We would like <code class="docutils literal notranslate"><span class="pre">jax.jacfwd(x)</span></code> to return the right hand side
callable <code class="docutils literal notranslate"><span class="pre">f(t,</span> <span class="pre">x)</span></code>.</p></li>
<li><p>We would like evaluating <code class="docutils literal notranslate"><span class="pre">x(t)</span></code> at different <code class="docutils literal notranslate"><span class="pre">t</span></code> as simple as
function calls, i.e., <code class="docutils literal notranslate"><span class="pre">x(0.0)</span></code>, <code class="docutils literal notranslate"><span class="pre">x(1.0)</span></code>, <code class="docutils literal notranslate"><span class="pre">x(2.0)</span></code>, …</p></li>
</ol>
<p>In addition, motivated by general relativistic ray tracing (GRRT)
applications, where it is common to integrate the geodesics backward
in the affine parameter, we also want the following.</p>
<ol class="arabic simple" start="3">
<li><p><code class="docutils literal notranslate"><span class="pre">XAJ</span></code> should support integrating in both positive and negative
<code class="docutils literal notranslate"><span class="pre">t</span></code> directions.</p></li>
</ol>
</section>
<section id="composability">
<h2>Composability<a class="headerlink" href="#composability" title="Permalink to this headline">¶</a></h2>
<p>To make <code class="docutils literal notranslate"><span class="pre">XAJ</span></code> work with the rest of the <code class="docutils literal notranslate"><span class="pre">JAX</span></code> ecosystem, we
require the following.</p>
<ol class="arabic simple" start="4">
<li><p><code class="docutils literal notranslate"><span class="pre">odeint</span></code> should have built-in pytree support just like <code class="docutils literal notranslate"><span class="pre">grad</span></code>.
See, e.g., the <code class="docutils literal notranslate"><span class="pre">JAX</span></code>
<a class="reference external" href="https://jax.readthedocs.io/en/latest/jax-101/05.1-pytrees.html#example-ml-model-parameters">MLP example</a>.</p></li>
<li><p>The numerical solution <code class="docutils literal notranslate"><span class="pre">x(t)</span></code> should support other <code class="docutils literal notranslate"><span class="pre">JAX</span></code>
transformations such as <code class="docutils literal notranslate"><span class="pre">jit</span></code> and <code class="docutils literal notranslate"><span class="pre">vmap</span></code>.</p></li>
</ol>
<p>Because of the Single Instruction, Multiple Data (SIMD) architectures
of GPUs and TPUs, we don’t expect performance gain by evaluating
different systems of ODEs at the same time.
Hence, <code class="docutils literal notranslate"><span class="pre">vmap</span></code> over different <code class="docutils literal notranslate"><span class="pre">f(t,</span> <span class="pre">x)</span></code> is not supported in
<code class="docutils literal notranslate"><span class="pre">XAJ</span></code>, just like <code class="docutils literal notranslate"><span class="pre">JAX</span></code> does not support vmapping to multiple
functions <code class="docutils literal notranslate"><span class="pre">vmap(grad)([f1,</span> <span class="pre">f2,</span> <span class="pre">f3])</span></code>.</p>
<p>Although it may seem natural to allow implicit vectorization, i.e., to
use <code class="docutils literal notranslate"><span class="pre">x(jnp.array([0.0,</span> <span class="pre">1.0,</span> <span class="pre">2.0]))</span></code> to evaluate <code class="docutils literal notranslate"><span class="pre">x(t)</span></code> pointwisely
on the array <code class="docutils literal notranslate"><span class="pre">t</span></code> , we purposely disfavor it in order to be
consistent with <code class="docutils literal notranslate"><span class="pre">JAX</span></code>’s derivative interface <code class="docutils literal notranslate"><span class="pre">grad</span></code>, <code class="docutils literal notranslate"><span class="pre">jacfwd</span></code>,
and <code class="docutils literal notranslate"><span class="pre">jacrev</span></code>.</p>
<ol class="arabic simple" start="6">
<li><p>The preferred way to evaluate <code class="docutils literal notranslate"><span class="pre">x(t)</span></code> pointwisely is to <code class="docutils literal notranslate"><span class="pre">vmap</span></code>
it for arbitrary pytree <code class="docutils literal notranslate"><span class="pre">t</span></code>, i.e., <code class="docutils literal notranslate"><span class="pre">vmap(x)(t)</span></code>.</p></li>
<li><p>We should support <code class="docutils literal notranslate"><span class="pre">vmap</span></code> over the initial conditions.
This complicates our design but we can expect something similar to
<code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">vmap(odeint(f))(t0,</span> <span class="pre">x0)</span></code> to work, where <code class="docutils literal notranslate"><span class="pre">t0</span></code> and <code class="docutils literal notranslate"><span class="pre">x0</span></code>
are arbitrary pytrees.</p></li>
<li><p>We should also support <code class="docutils literal notranslate"><span class="pre">vmap</span></code> over auxiliary parameters of the
ODEs.
This allows, for example, integrating geodesics around multiple
black holes with different spins.
The interface should be compatible with vmapping over initial
conditions, i.e., <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">vmap(odeint(f))(aux=aux)</span></code> where <code class="docutils literal notranslate"><span class="pre">aux</span></code> is
an arbitrary pytree.</p></li>
</ol>
</section>
<section id="call-signature">
<h2>Call Signature<a class="headerlink" href="#call-signature" title="Permalink to this headline">¶</a></h2>
<p>How should we design the call signature of <code class="docutils literal notranslate"><span class="pre">odeint</span></code>, its invert
function, and the numerical solution?
Because ODEs are uniquely specified only when the initial conditions
are given, <code class="docutils literal notranslate"><span class="pre">XAJ</span></code>’s integration interface is more complicated than
<code class="docutils literal notranslate"><span class="pre">JAX</span></code>’s derivative interface.</p>
<p>Let’s consider a specific ODE</p>
<div class="math notranslate nohighlight">
\[\frac{dx}{dt} = f(t, x) = x + t.\]</div>
<p>It has analytical solution <span class="math notranslate nohighlight">\(x(t) = c e^t - t - 1\)</span>.
Using the initial condition <span class="math notranslate nohighlight">\(x(t_0) = x_0\)</span>, we can rewrite the
analytical solution as</p>
<div class="math notranslate nohighlight">
\[x(t; t_0, x_0) = (x_0 + t_0 + 1)e^{t - t_0} - t - 1.\]</div>
<p>It is straightforward to verify <span class="math notranslate nohighlight">\(\partial_t x(t; t_0, x_0) = x -
t = f(t, x)\)</span>, where <span class="math notranslate nohighlight">\(t_0\)</span> and <span class="math notranslate nohighlight">\(x_0\)</span> can be seen as
parameters of the solution <span class="math notranslate nohighlight">\(x\)</span>.
Given that <code class="docutils literal notranslate"><span class="pre">jacfwd</span></code> (or <code class="docutils literal notranslate"><span class="pre">jacrev</span></code> or <code class="docutils literal notranslate"><span class="pre">grad</span></code>) by default takes the
derivatives with respect to only the first argument, we can use the
convention</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">odeint</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span>
<span class="n">jacfwd</span><span class="p">:</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">t0</span></code> are scalars and <code class="docutils literal notranslate"><span class="pre">f</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code>, and <code class="docutils literal notranslate"><span class="pre">x0</span></code> may be
arrays.
In the special case that <code class="docutils literal notranslate"><span class="pre">f</span></code> is independent of <code class="docutils literal notranslate"><span class="pre">t</span></code>, we have</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">odeint</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span>
<span class="n">jacfwd</span><span class="p">:</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">aux</span><span class="p">)</span>
</pre></div>
</div>
<p>We may see <code class="docutils literal notranslate"><span class="pre">odeint</span></code> as a functional (or high-order function) that
adds a new independent variable <code class="docutils literal notranslate"><span class="pre">t</span></code>, while <code class="docutils literal notranslate"><span class="pre">jacfwd</span></code> is its invert
and removes the independent variable.</p>
</section>
<section id="dual-integrators">
<h2>Dual Integrators<a class="headerlink" href="#dual-integrators" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">XAJ</span></code> needs to support integration in both positive and negative
directions according to requirement 3 above.
Unless the numerical integrator is <em>symmetric</em>, its behavior changes
depending on its integration direction.
Thus, what should be the meaning of selecting an integrator for
<code class="docutils literal notranslate"><span class="pre">XAJ</span></code>?</p>
<p>It is useful to guide our design based on consistency.
Suppose that an explicit integrator, e.g., forward Euler, is selected.
One <em>consistent</em> way to use the integrator is that the integration
from <code class="docutils literal notranslate"><span class="pre">x0</span> <span class="pre">=</span> <span class="pre">x(t0)</span></code> to <code class="docutils literal notranslate"><span class="pre">x1</span> <span class="pre">=</span> <span class="pre">x(t1)</span></code> always give the same
values of <code class="docutils literal notranslate"><span class="pre">x0</span></code> and <code class="docutils literal notranslate"><span class="pre">x1</span></code>, independent on whether <code class="docutils literal notranslate"><span class="pre">(t0,</span> <span class="pre">x0)</span></code> is
chosen as the initial condition and integrate is done toward <code class="docutils literal notranslate"><span class="pre">t1</span></code>,
or <code class="docutils literal notranslate"><span class="pre">(t1,</span> <span class="pre">x1)</span></code> is chosen as the initial condition and integrate is
done toward <code class="docutils literal notranslate"><span class="pre">t0</span></code>.
However, for this requirement to hold, we need to use the backward
Euler method when integrating from <code class="docutils literal notranslate"><span class="pre">t1</span></code> to <code class="docutils literal notranslate"><span class="pre">t0</span></code>.</p>
<p>This motivates the concept of dual integrators.
When setting up an integrator in <code class="docutils literal notranslate"><span class="pre">XAJ</span></code>, we should enable selecting a
pair of dual integrator, in addition using a single integrator for
both positive and negative directions.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">XAJ</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Interface Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#solution-callable">Solution Callable</a></li>
<li class="toctree-l2"><a class="reference internal" href="#composability">Composability</a></li>
<li class="toctree-l2"><a class="reference internal" href="#call-signature">Call Signature</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dual-integrators">Dual Integrators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pattern.html">Design Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementation.html">Implementation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter"><code class="docutils literal notranslate"><span class="pre">XAJ</span></code>: Numerical Integrators for <code class="docutils literal notranslate"><span class="pre">JAX</span></code></a></li>
      <li>Next: <a href="pattern.html" title="next chapter">Design Patterns</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Chi-kwan Chan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/interface.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>